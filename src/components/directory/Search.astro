---
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";
import formatString from "../../util/formatString";
import UiTagGrid from "../ui/tags/Grid.vue";
import UiTagSelect from "../ui/tags/Select.vue";
import config from "@util/themeConfig";

const searchPlaceholder = await getSearchPlaceholder();

async function getSearchPlaceholder() {
  if (
    config.directoryData.search?.placeholder &&
    config.directoryData.search.placeholder.includes("{0}")
  ) {
    const count = (await getCollection("directory")).length;
    return formatString(
      config.directoryData.search?.placeholder ?? "Search among {0} listings",
      count,
    );
  }

  return config.directoryData.search?.placeholder ?? "Search";
}
---

<div class="mb-10 not-prose">
  <div class="mt-2 flex rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
    <div class="relative flex flex-grow items-stretch focus-within:z-10">
      {
        config.directoryUI.search.icon ? (
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
            <Icon
              name={config.directoryUI.search.icon}
              class="h-5 w-5 text-[hsl(var(--muted-foreground))]"
              aria-hidden="true"
            />
          </div>
        ) : (
          ""
        )
      }
      <input
        id="search"
        class=`flex h-12 w-full rounded-xl border-2 border-[hsl(var(--input))] bg-[hsl(var(--background))] px-3 py-1 text-base shadow-sm transition-all file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-[hsl(var(--foreground))] placeholder:text-[hsl(var(--muted-foreground))] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[hsl(var(--ring))] focus-visible:border-[hsl(var(--primary))] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm ${config.directoryUI.search?.icon ? 'pl-12' : ''}`
        placeholder={searchPlaceholder}
      />
      <div class="absolute inset-y-0 right-0 flex py-2 pr-2">
        <kbd
          class="inline-flex items-center rounded-md border-2 border-[hsl(var(--border))] bg-[hsl(var(--muted))] px-2 py-1 font-sans text-xs text-[hsl(var(--muted-foreground))] shadow-sm"
          >âŒ˜K</kbd
        >
      </div>
    </div>
  </div>
  {
    () => {
      const sidebar = config.layout.sidebar;
      if (sidebar) {
        return <></>
      }
      if (config.directoryUI.search.tags.display === "select") {
        return (
          <UiTagSelect client:load>
            <Icon name="tabler:x" />
          </UiTagSelect>
        );
      }
      if (config.directoryUI.search.tags.display === "show-all") {
        return <UiTagGrid client:load />;
      }
    }
  }
</div>

<script>
  import { search } from "../../store.js";

  const searchInput = document.getElementById("search");

  // Add an event listener to the button
  searchInput?.addEventListener("input", (event: Event) => {
    const target = event.target as HTMLSelectElement;
    search.set(target.value);
  });

  const keyListener = function (e: KeyboardEvent) {
    if (e.key === "k" && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      searchInput?.focus();
    }

    if (e.key === "Escape") {
      e.preventDefault();
      searchInput?.blur();
    }
  };

  document.body.addEventListener("keydown", keyListener);
</script>
